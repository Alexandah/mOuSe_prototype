<!DOCTYPE html>
<html lang="en-us">
  <head>
    <title>DOM Hopper Demo</title>
    <style>
      .window {
        border: 1px solid black;
        padding: 10px;
        margin: 10px;
      }
      .block {
        border: 1px solid black;
        display: inline-block;
      }
      .registerNote {
        border: 1px solid black;
        background-color: #edd88c;
        display: inline-block;
        padding: 7px;
      }
    </style>
  </head>

  <body>
    <div class="window">
      <p>Hello! Here are the controls:</p>
      <ul>
        <li>j ~ down</li>
        <li>k ~ up</li>
        <li>h ~ left</li>
        <li>l ~ right</li>
        <li>Shift ~ go up in DOMHierarchy by 1</li>
        <li>Ctrl ~ go down in DOMHierarchy by 1</li>
        <li>Enter ~ right click (also opens links in new tabs)</li>
        <li>Spacebar ~ left click</li>
      </ul>
      <div class="window">
        <p>I'm a pretty sexy div</p>
      </div>
      <div class="window">
        <p>as am I ;)</p>
      </div>
      <div class="window">
        <p>But I am the dankest div!</p>
      </div>
    </div>
    <div class="window">
      <div class="block"><p>I am a block</p></div>
      <div class="block"><p>I am a block</p></div>
      <div class="block"><p>I am a block</p></div>
      <div class="block" onclick="alert('YEET!')"><p>Click me!</p></div>
      <div class="block"><p>I am a block</p></div>
      <div class="block"><p>I am a block</p></div>
      <div class="block" oncontextmenu="alert('YOU HAVE RIGHT CLICKED')">
        <p>Rite clix 0wnLi!</p>
      </div>
      <div class="block"><p>I am a block</p></div>
    </div>
    <div class="window">
      <p>I am a window!</p>
    </div>
    <div class="window">
      <p>I am also a window!</p>
      <input type="text" />
    </div>
    <div class="window">
      <p>I am a window!</p>
      <a href="http://www.erandalex.com">Our creator's website</a>
    </div>
    <div class="window">
      <p>I am a window!</p>
    </div>
    <div class="window">
      <p>I am a window!</p>
    </div>
    <div class="window">
      <p>I am a window!</p>
    </div>
    <div class="window">
      <p>I am a window!</p>
    </div>
    <div class="window">
      <p>I am a window!</p>
    </div>
    <div class="window">
      <p>I am a window!</p>
    </div>
    <div class="window">
      <p>I am a window!</p>
    </div>
    <div class="window">
      <p>I am a window!</p>
    </div>
    <div class="window">
      <p>I am a window!</p>
    </div>
    <div class="window">
      <p>I am a window!</p>
    </div>
    <div class="window">
      <p>I am a window!</p>
    </div>
    <div class="window">
      <p>I am a window!</p>
    </div>

    <script type="module">
      import DOMHopper from "./DOMHopper.js";
      import InputLanguage from "./InputLanguage.js";
      import KeyboardParser from "./KeyboardParser.js";

      var domHopper = new DOMHopper();

      const UP = "k";
      const DOWN = "j";
      const LEFT = "h";
      const RIGHT = "l";
      const PRIMARY_CLICK = " ";
      const SECONDARY_CLICK = "enter";
      const INC = "shift";
      const DEC = "control";
      const ESC = "escape";
      const COPY = "c";
      const R0 = "0";
      const R1 = "1";
      const R2 = "2";
      const R3 = "3";
      const R4 = "4";
      const R5 = "5";
      const R6 = "6";
      const R7 = "7";
      const R8 = "8";
      const R9 = "9";
      const REGISTERS = [R0, R1, R2, R3, R4, R5, R6, R7, R8, R9];
      const DEBUG = "alt";

      const TOKEN_ALLOWS_DUPLICATES = {
        [UP]: false,
        [DOWN]: false,
        [LEFT]: false,
        [RIGHT]: false,
        [PRIMARY_CLICK]: true,
        [SECONDARY_CLICK]: true,
        [INC]: true,
        [DEC]: true,
        [ESC]: false,
        [COPY]: false,
        [R0]: false,
        [R1]: false,
        [R2]: false,
        [R3]: false,
        [R4]: false,
        [R5]: false,
        [R6]: false,
        [R7]: false,
        [R8]: false,
        [R9]: false,
        [DEBUG]: false,
      };

      const DEFAULT_MODE = "DefaultMode";
      const EDITING_MODE = "EditingMode";

      //CONTROL SETTINGS
      var controls = new InputLanguage([
        UP,
        DOWN,
        LEFT,
        RIGHT,
        PRIMARY_CLICK,
        SECONDARY_CLICK,
        INC,
        DEC,
        COPY,
        ...REGISTERS,
        ESC,
        DEFAULT_MODE,
        EDITING_MODE,
        DEBUG,
      ]);

      //NAVIGATION MODE
      controls.defWord([DEFAULT_MODE, UP], () => domHopper.jumpUp());
      controls.defWord([DEFAULT_MODE, DOWN], () => domHopper.jumpDown());
      controls.defWord([DEFAULT_MODE, RIGHT], () => domHopper.jumpRight());
      controls.defWord([DEFAULT_MODE, LEFT], () => domHopper.jumpLeft());
      controls.defWord([DEFAULT_MODE, INC], () =>
        domHopper.moveSelectionLvlUp()
      );
      controls.defWord([DEFAULT_MODE, INC, INC], () =>
        domHopper.goToRootSelectionLvl()
      );
      controls.defWord([DEFAULT_MODE, DEC], () =>
        domHopper.moveSelectionLvlDown()
      );
      controls.defWord([DEFAULT_MODE, PRIMARY_CLICK], () =>
        domHopper.primaryClick()
      );
      controls.defWord([DEFAULT_MODE, SECONDARY_CLICK], () =>
        domHopper.secondaryClick()
      );
      REGISTERS.forEach((Ri) =>
        controls.defWord([DEFAULT_MODE, Ri], () =>
          domHopper.jumpToElementInRegister("r" + Ri)
        )
      );
      REGISTERS.forEach((Ri) =>
        controls.defWord([DEFAULT_MODE, COPY, Ri], () =>
          domHopper.copySelectedToRegister("r" + Ri)
        )
      );
      //debug
      controls.defWord([DEFAULT_MODE, DEBUG], () => {});

      //EDITOR MODE
      controls.defWord([EDITING_MODE, ESC], () => domHopper.exitEditingMode());

      //MODE SETTINGS
      var modeSettingsControls = new InputLanguage([
        DEFAULT_MODE,
        EDITING_MODE,
      ]);
      modeSettingsControls.defWord([DEFAULT_MODE], (event) => {
        event.preventDefault();
      });
      modeSettingsControls.defWord([EDITING_MODE], () => {});

      //MAIN INPUT PARSER
      var keyboardParser = new KeyboardParser();
      function parseRawInputIntoControlLanguage() {
        var editingMode = domHopper.editingMode ? EDITING_MODE : false;
        var defaultMode = !editingMode ? DEFAULT_MODE : false;
        var keys = keyboardParser.keys();
        const removeUnwantedDuplicates = (list) => {
          var seen = {};
          return list.filter((item) => {
            var key = item;
            if (TOKEN_ALLOWS_DUPLICATES[key]) {
              return true;
            }
            if (seen[key]) {
              return false;
            }
            seen[key] = true;
            return true;
          });
        };
        keys = removeUnwantedDuplicates(keys);
        var tokens = [...keys, editingMode, defaultMode];
        return tokens.filter((x) => x);
      }

      document.addEventListener("keydown", (event) => {
        var controlLanguageTokens = parseRawInputIntoControlLanguage();
        console.log("control tokens :", controlLanguageTokens);
        modeSettingsControls.read(controlLanguageTokens, [event]);
        controls.read(controlLanguageTokens);
      });

      console.log("Initialized DOMHopper Demo");
    </script>
  </body>
</html>
