<!DOCTYPE html>
<html lang="en-us">
  <head>
    <title>DOM Hopper Demo</title>
    <style>
      .window {
        border: 1px solid black;
        position: absolute;
      }
    </style>
  </head>

  <body>
    <p>Hello! Here are the controls:</p>
    <ul>
      <li>j ~ down</li>
      <li>k ~ up</li>
      <li>h ~ left</li>
      <li>l ~ right</li>
      <li>t ~ new window</li>
      <li>q ~ close window</li>
      <li>Enter ~ right click</li>
      <li>Spacebar ~ left click</li>
    </ul>

    <script>
      //Constants
      const ORANGE_OUTLINE_COLOR = "#ffa500";
      const BLACK_OUTLINE_COLOR = "#000000";
      const GREEN_OUTLINE_COLOR = "#0FFF50";

      //Helpers
      function get(id) {
        return document.getElementById(id);
      }

      function getClass(className) {
        return document.getElementsByClassName(className);
      }

      function getTags(tagName) {
        return document.getElementsByTagName(tagName);
      }

      function getTag(tagName) {
        return getTags(tagName)[0];
      }

      function getKeyContainingX(obj, X) {
        var keyContainingX = null;
        Object.keys(obj).forEach((key) => {
          if (obj[key].indexOf(X) !== -1) {
            keyContainingX = key;
          }
        });
        return keyContainingX;
      }

      //Entities
      class DOMHopper {
        constructor() {
          this.domLevels = {};
          var root = getTag("body");
          this.chartDOMLevels(root, 0);
          this.selected = null;
          this.selected = this.setSelected(root);
          this.selectedDOMLvl = 0;
        }

        chartDOMLevels(parentNode, lvl) {
          if (this.domLevels.hasOwnProperty(lvl)) {
            this.domLevels[lvl].push(parentNode);
          } else {
            this.domLevels[lvl] = [parentNode];
          }
          if (parentNode != null) parentNode.lvl = lvl;

          if (parentNode.hasChildNodes()) {
            for (var i = 0; i < parentNode.childNodes.length; i++) {
              this.chartDOMLevels(parentNode.childNodes[i], lvl + 1);
            }
          }
        }

        getSelectedDOMLvlElements() {
          if (this.selectedDOMLvl == null) return null;
          return this.domLevels[this.selectedDOMLvl];
        }

        setSelected(element) {
          if (element !== this.selected)
            element.oldBorder = element.style.border;
          if (this.selected != null)
            this.selected.style.border = this.selected.oldBorder;
          element.style.border = "1px solid " + ORANGE_OUTLINE_COLOR;
          this.selected = element;
        }

        getElementClosestToSelectedFrom(elements) {
          var closest = null;
          var closestDistance = Infinity;
          elements.forEach((element) => {
            var distance =
              Math.abs(element.x - this.selected.x) +
              Math.abs(element.y - this.selected.y);
            if (distance < closestDistance) {
              closest = element;
              closestDistance = distance;
            }
          });
          if (closest == null) return this.selected;
          else return closest;
        }

        jump(dirFunc) {
          if (this.selected != null) {
            var elementsAbove =
              this.getSelectedDOMLvlElements().filter(dirFunc);
            var jumpTo = this.getElementClosestToSelectedFrom(elementsAbove);
            this.setSelected(jumpTo);
          }
        }
        jumpUp() {
          this.jump((element) => element.y < this.selected.y);
        }
        jumpDown() {
          this.jump((element) => element.y > this.selected.y);
        }
        jumpLeft() {
          this.jump((element) => element.x < this.selected.x);
        }
        jumpRight() {
          this.jump((element) => element.x > this.selected.x);
        }

        moveSelectionLvlUp() {
          if (this.selectedDOMLvl == 0) return;
          this.selectedDOMLvl--;
          var parent = this.getSelectedDOMLvlElements().find(
            (element) => element === this.selected.parent
          );
          this.setSelected(parent);
        }
        moveSelectionLvlDown() {
          var hasNextDOMLvl = this.selectedDOMLvl + 1 in this.domLevels;
          if (!hasNextDOMLvl) return;
          this.selectedDOMLvl++;
          var selectedHasChild = this.selected.hasChildNodes();
          var descendant = selectedHasChild
            ? this.selected.firstChild
            : this.domLevels[this.selectedDOMLvl][0];
          this.setSelected(descendant);
        }
      }
    </script>
  </body>
</html>
